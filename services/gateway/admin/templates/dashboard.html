<!-- admin/templates/dashboard.html -->
<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="utf-8">
    <title>×¤×× ×œ × ×™×”×•×œ ×”×‘×•×˜×™×</title>
    <style>
        body { font-family: Arial, sans-serif; direction: rtl; background:#f4f7fb; margin:20px; }
        .container { max-width:1200px; margin:0 auto; }
        header { display:flex; justify-content:space-between; align-items:center; }
        h1 { margin:0; }
        .small { font-size:0.9em; color:#666; }
        .box { background:#fff; padding:12px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.06); margin-top:10px; }
        button { padding:6px 10px; margin-left:6px; cursor:pointer; }
        pre { background:#f7f9fc; padding:10px; border-radius:6px; overflow:auto; max-height:300px; }
        table { width:100%; border-collapse:collapse; margin-top:8px; }
        th, td { padding:8px; border-bottom:1px solid #eee; text-align:right; }
        .leader { display:flex; gap:12px; flex-wrap:wrap; }
        .leader .card { background:#fff; padding:8px 12px; border-radius:6px; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
        .status-healthy { color: #2e7d32; }
        .status-warning { color: #f57c00; }
        .status-error { color: #d32f2f; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px; }
        .stat-card { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; }
        .stat-value { font-size: 1.5em; font-weight: bold; margin: 4px 0; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ“Š ×¤×× ×œ × ×™×”×•×œ ×”×‘×•×˜×™×</h1>
        <div class="small">×©×¨×ª: {{ system.domain }} â€¢ ×‘×•×˜×™×: {{ system.bot_count }} â€¢ ×”×•×“×¢×•×ª: {{ system.message_count }} â€¢ ×ª×œ×•×™×™×: {{ system.pending_count }}</div>
    </header>

    <!-- ×¡×¢×™×£ ××“×“×™× ×—×“×© -->
    <div class="box">
        <h3>ğŸ“ˆ ××“×“×™× ×•×ª×§×œ×•×ª</h3>
        <div class="stats-grid">
            <div class="stat-card" style="background: #e8f5e8;">
                <div>×”×•×“×¢×•×ª ×©×”×ª×§×‘×œ×•</div>
                <div class="stat-value">{{ system.message_count }}</div>
                <div class="small">×¡×”"×›</div>
            </div>
            <div class="stat-card" style="background: #fff3e0;">
                <div>×‘×§×©×•×ª ×××ª×™× ×•×ª</div>
                <div class="stat-value">{{ system.pending_count }}</div>
                <div class="small">×œ××™×©×•×¨</div>
            </div>
            <div class="stat-card" style="background: #ffebee;">
                <div>×ª×§×œ×•×ª ×—×™×‘×•×¨</div>
                <div class="stat-value">{{ system.connection_errors }}</div>
                <div class="small">×¡×”"×›</div>
            </div>
            <div class="stat-card" style="background: #e3f2fd;">
                <div>×©×œ×™×—×•×ª ××•×¦×œ×—×•×ª</div>
                <div class="stat-value">{{ system.successful_sends }}</div>
                <div class="small">â‰ˆ</div>
            </div>
        </div>
    </div>

    <div class="box">
        <h3>××¦×‘ Webhooks ××”×™×¨</h3>
        <div>
            {% for w in webhook_summary %}
                <div>
                    <strong>{{ w.env_key }}</strong> â€” index: {{ w.bot_index }} â€” token: {{ '×›×Ÿ' if w.has_token else '×œ×' }}
                </div>
            {% endfor %}
        </div>
        <div style="margin-top:10px;">
            <button onclick="fetchWebhookInfo()">×”×¦×’ getWebhookInfo ×œ×›×œ ×”×˜×•×§× ×™×</button>
            <button onclick="resetWebhooks()">××¤×¡/×”×’×“×¨ Webhooks (setWebhook)</button>
            <button onclick="checkBotsHealth()">×‘×“×™×§×ª ×‘×¨×™××•×ª ×”×‘×•×˜×™×</button>
        </div>
        <div id="webhookResults" style="margin-top:10px;"></div>
        <div id="healthResults" style="margin-top:10px;"></div>
    </div>

    <div class="box" style="margin-top:12px;">
        <h3>×’×¨×£ ×¤×¢×™×œ×•×ª ×œ×¤×™ ×©×¢×•×ª</h3>
        <img src="data:image/png;base64,{{ plot_b64 }}" alt="activity" style="width:100%;">
    </div>

    <div class="box" style="margin-top:12px;">
        <h3>×˜×‘×œ×ª ×¤× ×™×•×ª ×××ª×™× ×•×ª ×œ××™×©×•×¨</h3>
        {% if pending %}
            <table>
                <tr><th>×–××Ÿ</th><th>×‘×•×˜</th><th>××©×ª××©</th><th>×˜×§×¡×˜</th><th>×¤×¢×•×œ×•×ª</th></tr>
                {% for p in pending %}
                <tr style="background:#fffbe6;">
                    <td>{{ p.timestamp }}</td>
                    <td>{{ p.bot }}</td>
                    <td>{{ p.user }}</td>
                    <td>{{ p.text }}</td>
                    <td>
                        <form style="display:inline" method="post" action="/approve">
                            <input type="hidden" name="entry_id" value="{{ p.id }}">
                            <button type="submit">××©×¨</button>
                        </form>
                        <button onclick="openReject('{{ p.id }}')">×“×—×”</button>
                    </td>
                </tr>
                {% endfor %}
            </table>
        {% else %}
            <div class="small">××™×Ÿ ×‘×§×©×•×ª ×××ª×™× ×•×ª ×›×¨×’×¢.</div>
        {% endif %}
    </div>

    <div class="box" style="margin-top:12px;">
        <h3>×œ×•×— ××•×‘×™×œ×™× (Leaderboard)</h3>
        <div class="leader">
            {% for item in leaderboard %}
                <div class="card"><strong>{{ item.user_id }}</strong><br><small>× ×§×•×“×•×ª: {{ item.points }}</small></div>
            {% endfor %}
        </div>
        <div style="margin-top:8px;">
            <form method="post" action="/generate_referral">
                <label>×¦×•×¨ ×œ×™× ×§ ×”×¤× ×™×” ×¢×‘×•×¨ ××©×ª××© (user_id):</label>
                <select name="env_key">
                    {% for w in webhook_summary %}
                        <option value="{{ w.env_key }}">{{ w.env_key }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="user_id" placeholder="×”×§×œ×“ chat_id ×©×œ ×”××©×ª××©">
                <button type="submit">×¦×•×¨ ×œ×™× ×§</button>
            </form>
            <div style="margin-top:6px;">
                <a href="/export/referrals.csv">×™×™×¦× CSV ×©×œ ×”×”×¤× ×™×•×ª</a>
            </div>
        </div>
    </div>

    <!-- ×¡×¢×™×£ × ×™×”×•×œ ×§×¨×™×¤×˜×• -->
    <div class="box" style="margin-top:12px;">
        <h3>ğŸ’° × ×™×”×•×œ ×§×¨×™×¤×˜×•</h3>
        <div class="stats-grid">
            <div class="stat-card" style="background: #e3f2fd;">
                <div>××¨× ×§×™× ×©× ×•×¦×¨×•</div>
                <div class="stat-value" id="walletCount">{{ system.crypto_wallet_count }}</div>
                <div class="small">×¡×”"×›</div>
            </div>
            <div class="stat-card" style="background: #e8f5e8;">
                <div>×¢×¡×§××•×ª</div>
                <div class="stat-value" id="transactionCount">{{ system.crypto_transaction_count }}</div>
                <div class="small">×”×™×•×</div>
            </div>
            <div class="stat-card" style="background: #fff3e0;">
                <div>××—×™×¨ {{ system.token_symbol }}</div>
                <div class="stat-value">${{ system.token_price }}</div>
                <div class="small">× ×•×›×—×™</div>
            </div>
        </div>
        
        <div style="margin-top: 12px;">
            <button onclick="loadCryptoStats()">×¨×¢× ×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª</button>
            <button onclick="showBusinessWallet()">××¨× ×§ ×¢×¡×§×™</button>
            <button onclick="exportWallets()">×™×™×¦× ××¨× ×§×™×</button>
        </div>
        
        <div id="cryptoResults" style="margin-top: 10px;"></div>
    </div>

    <div class="box" style="margin-top:12px;">
        <h3>×›×œ ×”×”×•×“×¢×•×ª ×©×”×ª×§×‘×œ×• (×—×“×©×•×ª ×œ××¢×œ×”)</h3>
        <table>
            <tr><th>×–××Ÿ</th><th>×‘×•×˜</th><th>××©×ª××©</th><th>×¦'××˜ ID</th><th>×˜×§×¡×˜</th><th>referrer</th><th>×¡×˜×˜×•×¡</th></tr>
            {% for m in messages %}
            <tr>
                <td>{{ m.timestamp }}</td>
                <td>{{ m.bot }}</td>
                <td>{{ m.user }}</td>
                <td>{{ m.chat_id }}</td>
                <td>{{ m.text }}</td>
                <td>{{ m.referrer_id if m.referrer_id else "-" }}</td>
                <td>
                    {% if m.status == 'approved' %}
                        <span style="color: green;">âœ“ ××•×©×¨</span>
                    {% elif m.status == 'rejected' %}
                        <span style="color: red;">âœ— × ×“×—×”</span>
                    {% elif m.status == 'pending' %}
                        <span style="color: orange;">â³ ×××ª×™×Ÿ</span>
                    {% else %}
                        {{ m.status }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
</div>

<!-- Reject modal -->
<div id="rejectModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4);">
    <div style="background:#fff; width:420px; margin:80px auto; padding:20px; border-radius:8px;">
        <h3>×“×—×™×™×ª ×¤× ×™×™×”</h3>
        <form method="post" action="/reject">
            <input type="hidden" id="rejectEntryId" name="entry_id" value="">
            <div>
                <label>×¡×™×‘×ª ×”×“×—×™×™×”</label><br>
                <textarea name="reason" rows="4" style="width:100%"></textarea>
            </div>
            <div style="margin-top:8px;">
                <button type="submit">×©×œ×— ×“×—×™×™×”</button>
                <button type="button" onclick="closeReject()">×‘×˜×œ</button>
            </div>
        </form>
    </div>
</div>

<script>
function openReject(id){
    document.getElementById('rejectEntryId').value = id;
    document.getElementById('rejectModal').style.display = 'block';
}
function closeReject(){
    document.getElementById('rejectModal').style.display = 'none';
}

async function fetchWebhookInfo(){
    const resDiv = document.getElementById('webhookResults');
    resDiv.innerHTML = '×©×•×œ×— ×‘×§×©×”...';
    try{
        const r = await fetch('/webhook_info');
        const data = await r.json();
        resDiv.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
    }catch(e){
        resDiv.innerHTML = '<pre>×©×’×™××”: ' + e + '</pre>';
    }
}

async function resetWebhooks(){
    if(!confirm('×”×× ×œ××¤×¡/×œ×”×’×“×™×¨ ×©×•×‘ ××ª ×›×œ ×”â€‘webhooks ×¢×›×©×™×•?')) return;
    const resDiv = document.getElementById('webhookResults');
    resDiv.innerHTML = '×× ×¡×” ×œ×”×’×“×™×¨ webhooks...';
    try{
        const r = await fetch('/reset_webhooks', {method:'POST'});
        const data = await r.json();
        resDiv.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
    }catch(e){
        resDiv.innerHTML = '<pre>×©×’×™××”: ' + e + '</pre>';
    }
}

async function checkBotsHealth(){
    const resDiv = document.getElementById('healthResults');
    resDiv.innerHTML = '×‘×•×“×§ ××ª ××¦×‘ ×”×‘×•×˜×™×...';
    try{
        const r = await fetch('/health_check');
        const data = await r.json();
        
        let html = '<h4>×“×•×— ×‘×¨×™××•×ª ×”×‘×•×˜×™×:</h4>';
        for (const [botName, info] of Object.entries(data)) {
            const health = info.health;
            let statusClass = 'status-error';
            let statusText = 'âŒ ×ª×§×œ×”';
            
            if (health.status === 'healthy') {
                statusClass = 'status-healthy';
                statusText = 'âœ… ×ª×§×™×Ÿ';
            } else if (health.status === 'timeout' || health.status === 'connection_error') {
                statusClass = 'status-warning';
                statusText = 'âš ï¸ ×‘×¢×™×™×ª ×—×™×‘×•×¨';
            }
            
            html += `
                <div style="margin: 8px 0; padding: 8px; border-left: 4px solid ${health.status === 'healthy' ? '#4caf50' : health.status === 'timeout' ? '#ff9800' : '#f44336'};">
                    <strong>${botName}</strong> - <span class="${statusClass}">${statusText}</span>
                    ${health.username ? `<br><small>×©×: ${health.username} (ID: ${health.bot_id})</small>` : ''}
                    ${health.error ? `<br><small>×©×’×™××”: ${health.error}</small>` : ''}
                </div>
            `;
        }
        
        resDiv.innerHTML = html;
    }catch(e){
        resDiv.innerHTML = '<pre>×©×’×™××”: ' + e + '</pre>';
    }
}

async function loadCryptoStats() {
    const resDiv = document.getElementById('cryptoResults');
    resDiv.innerHTML = '×˜×•×¢×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª...';
    try {
        const r = await fetch('/crypto_stats');
        const data = await r.json();
        
        if (data.error) {
            resDiv.innerHTML = '<pre>×©×’×™××”: ' + data.error + '</pre>';
            return;
        }
        
        document.getElementById('walletCount').textContent = data.wallet_count;
        document.getElementById('transactionCount').textContent = data.transaction_count;
        
        resDiv.innerHTML = `
            <div style="color: green;">âœ… ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×•×“×›× ×•</div>
            <div>××¨× ×§×™×: ${data.wallet_count}, ×¢×¡×§××•×ª ×”×™×•×: ${data.transaction_count}</div>
        `;
    } catch(e) {
        resDiv.innerHTML = '<pre>×©×’×™××”: ' + e + '</pre>';
    }
}

async function showBusinessWallet() {
    const resDiv = document.getElementById('cryptoResults');
    resDiv.innerHTML = '×˜×•×¢×Ÿ ×¤×¨×˜×™ ××¨× ×§ ×¢×¡×§×™...';
    try {
        const r = await fetch('/business_wallet');
        const data = await r.json();
        
        if (data.error) {
            resDiv.innerHTML = '<pre>×©×’×™××”: ' + data.error + '</pre>';
            return;
        }
        
        resDiv.innerHTML = `
            <h4>××¨× ×§ ×¢×¡×§×™:</h4>
            <div><strong>×›×ª×•×‘×ª:</strong> ${data.address}</div>
            <div><strong>×™×ª×¨×ª BNB:</strong> ${data.balance_bnb.toFixed(6)}</div>
            <div><strong>×¢×¨×š ×‘×“×•×œ×¨:</strong> $${data.balance_usd.toFixed(2)}</div>
            <div><strong>×¨×©×ª:</strong> ${data.network}</div>
        `;
    } catch(e) {
        resDiv.innerHTML = '<pre>×©×’×™××”: ' + e + '</pre>';
    }
}

async function exportWallets() {
    try {
        const r = await fetch('/export_wallets');
        if (r.ok) {
            const blob = await r.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'wallets.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.getElementById('cryptoResults').innerHTML = '<div style="color: green;">âœ… ×”×§×•×‘×¥ ×”×•×¨×“</div>';
        } else {
            document.getElementById('cryptoResults').innerHTML = '<div style="color: red;">âŒ ×©×’×™××” ×‘×”×•×¨×“×”</div>';
        }
    } catch(e) {
        document.getElementById('cryptoResults').innerHTML = '<pre>×©×’×™××”: ' + e + '</pre>';
    }
}

// ×˜×¢×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×§×¨×™×¤×˜×• ××•×˜×•××˜×™×ª
window.addEventListener('load', function() {
    setTimeout(loadCryptoStats, 1000);
    setTimeout(checkBotsHealth, 1000);
});
</script>
</body>
</html>
